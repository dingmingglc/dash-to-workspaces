#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Extract .ui translatable strings, add to zh_CN .po with Chinese, then compile .mo."""
import glob
import re
import subprocess

# All UI strings -> Chinese (expand as needed; missing keys will keep English in .po)
UI_TRANS = {
    "About": "关于",
    "Action": "操作",
    "Activate panel menu buttons on click only": "仅点击时激活面板菜单按钮",
    "Add entry": "添加条目",
    "Allow the panel to be revealed while in fullscreen mode": "全屏时也允许显示面板",
    "All windows": "所有窗口",
    "All windows except for the peeked one have their opacity set to the same value.": "除正在窥视的窗口外，其余窗口使用相同不透明度。",
    "Always visible": "始终可见",
    "Anchor": "锚点",
    "Animate": "动画",
    "Animate hovering app icons": "悬停时动画应用图标",
    "Animate launching new windows": "启动新窗口时动画",
    "Animate switching applications": "切换应用时动画",
    "Animation time (ms)": "动画时间（毫秒）",
    "Animation type": "动画类型",
    "App Icon Margin": "应用图标边距",
    "App Icon Padding": "应用图标内边距",
    "App icon size": "应用图标大小",
    "AppIcon style": "应用图标样式",
    "Application icons context menu": "应用图标右键菜单",
    "Applications": "应用程序",
    "Apply changes to all monitors": "将更改应用到所有显示器",
    "Apply to all": "应用到全部",
    "Avoid Dash to Panel overlap": "避免与 Dash to Panel 重叠",
    "Behavior": "行为",
    "Behavior for Middle-Click.": "中键点击行为。",
    "Behavior for Shift+Middle-Click.": "Shift+中键点击行为。",
    "Behavior when mouse scrolling over an application icon.": "在应用图标上滚动鼠标时的行为。",
    "Behavior when mouse scrolling over the panel.": "在面板上滚动鼠标时的行为。",
    "Behaviour when clicking on the icon of a running application.": "点击运行中应用图标时的行为。",
    "Below Preview": "预览下方",
    "bold": "粗体",
    "bolder": "更粗",
    "Border radius": "圆角",
    "Border thickness": "边框粗细",
    "Both": "两者",
    "Bottom": "下",
    "Bottom Left (Inside)": "左下（内侧）",
    "Bottom Right (Inside)": "右下（内侧）",
    "Change opacity to (%)": "不透明度调整为（%）",
    "Change opacity when a window gets closer than (px)": "窗口距离小于（像素）时调整不透明度",
    "Change opacity when a window gets close to the panel": "窗口靠近面板时调整不透明度",
    "Change volume": "调节音量",
    "Choose what to display: current panel, preview, or both": "选择显示内容：当前面板、预览或两者",
    "Ciliora": "Ciliora",
    "Click action": "点击操作",
    "Click empty space to close overview": "点击空白处关闭概览",
    "Close button and header position": "关闭按钮与标题位置",
    "Convexity": "凸度",
    "Current Panel": "当前面板",
    "Custom color": "自定义颜色",
    "Cycle through windows": "在窗口间循环",
    "Cycle windows": "循环窗口",
    "Cycle windows + minimize": "循环窗口并最小化",
    "Dashes": "短线",
    "Delay before enabling intellihide on start (ms)": "启动后启用智能隐藏前的延迟（毫秒）",
    "Delay before hiding the panel (ms)": "隐藏面板前的延迟（毫秒）",
    "Delay before revealing the desktop (ms)": "显示桌面前的延迟（毫秒）",
    "Delay before revealing the panel (ms)": "显示面板前的延迟（毫秒）",
    "Delay between mouse scroll events (ms)": "鼠标滚动事件间隔（毫秒）",
    "Disable show overview on startup": "启动时不显示概览",
    "Display mode": "显示模式",
    "Display panels on all monitors": "在所有显示器上显示面板",
    "Display running indicators on unfocused applications": "在未聚焦应用上显示运行指示器",
    "Display the main panel on": "主面板显示在",
    "Display window preview headers": "显示窗口预览标题",
    "Do nothing": "无操作",
    "Dots": "圆点",
    "Duration": "持续时间",
    "Dynamic": "动态",
    "Dynamic background opacity": "动态背景不透明度",
    "Enable Super+(0-9) as shortcuts to activate apps. It can also be used together with Shift and Ctrl.": "使用 Super+(0-9) 作为激活应用的快捷键，可与 Shift、Ctrl 组合。",
    "Enable window peeking": "启用窗口窥视",
    "End": "末尾",
    "Enter window peeking mode timeout (ms)": "进入窗口窥视模式的超时（毫秒）",
    "Export and Import": "导出与导入",
    "Export and import settings": "导出与导入设置",
    "Export to file": "导出到文件",
    "Extent": "范围",
    "Fade duration (ms)": "淡入淡出时长（毫秒）",
    "Fine-Tune": "微调",
    "Fixed": "固定",
    "Focused windows": "聚焦窗口",
    "Font color of the application titles": "应用标题字体颜色",
    "Font color of the minimized application titles": "最小化应用标题字体颜色",
    "Font color of the preview titles": "预览标题字体颜色",
    "Font size": "字体大小",
    "Font size (px) of the application titles (default is 14)": "应用标题字体大小（像素，默认 14）",
    "Font size (px) of the preview titles": "预览标题字体大小（像素）",
    "Font weight of application titles": "应用标题字重",
    "Font weight of the preview titles": "预览标题字重",
    "Force Activities hot corner on primary monitor": "在主显示器强制活动热角",
    "GitHub": "GitHub",
    "Global style": "全局样式",
    "Gnome functionality": "GNOME 功能",
    "Gradient bottom color and opacity (%)": "渐变底部颜色与不透明度（%）",
    "Gradient top color and opacity (%)": "渐变顶部颜色与不透明度（%）",
    "Grayscale": "灰度",
    "Hide and reveal animation duration (ms)": "隐藏与显示动画时长（毫秒）",
    "Hide and reveal the panel according to preferences": "根据偏好隐藏与显示面板",
    "Hide timeout (ms)": "隐藏超时（毫秒）",
    "Highlight AppIcon border radius": "高亮应用图标圆角",
    "Highlight AppIcon color": "高亮应用图标颜色",
    "Highlight focused application": "高亮聚焦应用",
    "Highlight hovering app icons": "高亮悬停时的应用图标",
    "Highlight opacity": "高亮不透明度",
    "Hotkey overlay": "快捷键叠加",
    "Hotkeys are activated with": "快捷键激活方式",
    "Hotkeys prefix": "快捷键前缀",
    "Hotkeys will either be Super+Number or Super+Alt+Num": "快捷键为 Super+数字 或 Super+Alt+数字",
    "Hover": "悬停",
    "Hovering the panel area keeps the panel revealed": "鼠标在面板区域时保持面板显示",
    "Icon dominant color": "图标主色",
    "Icon size (px) of the window preview": "窗口预览图标大小（像素）",
    "Icon style": "图标样式",
    "If disabled, the previews background have the same opacity as the panel.": "若关闭，预览背景与面板使用相同不透明度。",
    "If disabled, the previews icon size will be based on headerbar size": "若关闭，预览图标大小将基于标题栏高度",
    "If enabled and Dash to Panel extension is active, adjust preview position to avoid overlapping with Dash to Panel panel": "若启用且 Dash to Panel 已启用，将调整预览位置避免与其重叠",
    "If enabled, icons keep a stable order (do not reorder when activating apps)": "若启用，图标保持固定顺序（激活应用时不重排）",
    "Immediate on application icon click": "点击应用图标时立即响应",
    "Import from file": "从文件导入",
    "Indicator color - Icon Dominant": "指示器颜色 - 图标主色",
    "Indicator color - Override Theme": "指示器颜色 - 覆盖主题",
    "Indicator size (px)": "指示器大小（像素）",
    "Info": "信息",
    "inherit from theme": "继承自主题",
    "Inside": "内侧",
    "Isolate": "隔离",
    "Isolate monitors": "隔离显示器",
    "Isolate monitors even when using a single panel": "即使使用单一面板也隔离显示器",
    "Isolate Workspaces": "隔离工作区",
    "Isolate workspaces in gnome-shell Application Switcher": "在 GNOME Shell 应用切换器中隔离工作区",
    "Keep app icons order": "保持应用图标顺序",
    "Keep original gnome-shell dash": "保留 GNOME Shell 原始 dock",
    "Keep original gnome-shell top panel": "保留 GNOME Shell 原始顶栏",
    "Keyboard shortcut to reveal and hold the panel": "显示并固定面板的快捷键",
    "Launch new instance": "启动新实例",
    "Left": "左",
    "LeftBox Font Size": "左侧区域字体大小",
    "LeftBox Padding": "左侧区域内边距",
    "lighter": "更浅",
    "Limit to panel length": "限制为面板长度",
    "Maximized windows": "最大化窗口",
    "Maximum width (px) of the application titles": "应用标题最大宽度（像素）",
    "Metro": "Metro",
    "Middle": "中",
    "Middle-Click action": "中键点击操作",
    "Middle click on the preview to close the window": "中键点击预览以关闭窗口",
    "Minimize window": "最小化窗口",
    "Monitor": "显示器",
    "Name position": "名称位置",
    "Never": "从不",
    "normal": "正常",
    "Normal": "正常",
    "Number overlay": "数字叠加",
    "Number row": "数字行",
    "Numeric keypad": "数字键盘",
    "Only hide secondary panels": "仅隐藏次要面板",
    "Only hide the panel from windows": "仅在有窗口时隐藏面板",
    "On same monitor": "同一显示器",
    "On secondary monitors, show the overlay on icons matching the primary monitor": "在次要显示器上，在与主显示器匹配的图标上显示叠加",
    "Opacity change animation duration (ms)": "不透明度变化动画时长（毫秒）",
    "Order and Position on monitors": "显示器上的顺序与位置",
    "Outside": "外侧",
    "Overlapping": "重叠",
    "Override border color": "覆盖边框颜色",
    "Override escape key and return to desktop": "覆盖 Escape 键并返回桌面",
    "Override panel theme background color": "覆盖面板主题背景色",
    "Override panel theme background opacity": "覆盖面板主题背景不透明度",
    "Override panel theme gradient": "覆盖面板主题渐变",
    "Overrides global border radius (default is 0)": "覆盖全局圆角（默认为 0）",
    "Override Show Desktop line color": "覆盖“显示桌面”线条颜色",
    "Overview": "概览",
    "Padding": "内边距",
    "Panel": "面板",
    "Panel background opacity (%)": "面板背景不透明度（%）",
    "Panel border": "面板边框",
    "Panel context menu entries": "面板右键菜单条目",
    "Panel Intellihide": "面板智能隐藏",
    "Panel length": "面板长度",
    "Panel monitor position": "面板在显示器上的位置",
    "Panel style": "面板样式",
    "Panel thickness": "面板厚度",
    "Persist state across restarts": "重启后保持状态",
    "Plank": "Plank",
    "Position": "位置",
    "Position of workspace name relative to preview": "工作区名称相对于预览的位置",
    "Pressed AppIcon color": "按下时应用图标颜色",
    "Preview Panel": "预览面板",
    "Preview position": "预览位置",
    "Preview width": "预览宽度",
    "Quit": "退出",
    "Raise windows": "提升窗口",
    "Required pressure threshold (px)": "所需压力阈值（像素）",
    "Required pressure timeout (ms)": "所需压力超时（毫秒）",
    "Require pressure at the edge of the monitor to reveal the panel": "需在显示器边缘施加压力才显示面板",
    "Reveal and hold the panel on notification": "收到通知时显示并固定面板",
    "Reveal the desktop when hovering the Show Desktop button": "悬停“显示桌面”按钮时显示桌面",
    "Right": "右",
    "Ripple": "涟漪",
    "Rotation": "旋转",
    "Running indicator": "运行指示器",
    "Running indicator position": "运行指示器位置",
    "Running indicator style (Focused app)": "运行指示器样式（聚焦应用）",
    "Running indicator style (Unfocused apps)": "运行指示器样式（未聚焦应用）",
    "Same as panel": "与面板相同",
    "Scroll action": "滚动操作",
    "Scroll icon action": "滚动图标操作",
    "Scroll panel action": "滚动面板操作",
    "Secondary menu": "次级菜单",
    "Segmented": "分段",
    "Select which keyboard number keys are used to activate the hotkeys": "选择用于激活快捷键的数字键",
    "Shift+Click action": "Shift+点击操作",
    "Shift+Middle-Click action": "Shift+中键点击操作",
    "Shortcut to show the overlay for 2 seconds": "显示叠加 2 秒的快捷键",
    "Show Applications icon": "显示应用程序图标",
    "Show Applications icon side padding (px)": "显示应用程序图标侧边内边距（像素）",
    "Show favorite applications": "显示收藏应用",
    "Show favorite applications on secondary panels": "在次要面板上显示收藏应用",
    "Show notification counter badge": "显示通知计数角标",
    "Show popup when changing workspace": "切换工作区时显示弹出",
    "Show previews when the application have multiple instances": "应用有多实例时显示预览",
    "Show running applications": "显示运行中应用",
    "Show temporarily": "临时显示",
    "Show the overlay on all monitors": "在所有显示器上显示叠加",
    "Show tooltip on hover": "悬停时显示工具提示",
    "Show window previews on hotkey": "按快捷键时显示窗口预览",
    "Show window previews on hover": "悬停时显示窗口预览",
    "Show workspace preview outside or inside the panel": "在工作区预览外侧或面板内侧显示",
    "Side margins": "左右边距",
    "Side padding": "左右内边距",
    "Simple": "简单",
    "Size of the app icons shown below each workspace preview": "每个工作区预览下方应用图标的大小",
    "Solid": "实心",
    "Source": "来源",
    "Sponsored and originally developed by": "由 … 赞助并最初开发",
    "Squares": "方块",
    "Start": "起始",
    "Status Icon Padding": "状态图标内边距",
    "Style": "样式",
    "Switch workspace": "切换工作区",
    "Symbolic": "符号",
    "Taskbar Display": "任务栏显示",
    "The panel background opacity is affected by": "面板背景不透明度由以下决定",
    "The panel hides from": "面板在以下情况下隐藏",
    "This affects workspace popup when scrolling on the panel only.": "仅影响在面板上滚动时的工作区弹出。",
    "Time (ms) before hiding": "隐藏前时间（毫秒）",
    "Time (ms) before showing": "显示前时间（毫秒）",
    "Time of inactivity while hovering over a window preview needed to enter the window peeking mode.": "悬停窗口预览进入窥视模式所需的无操作时间。",
    "Toggle single / Cycle multiple": "切换单窗口 / 循环多窗口",
    "Toggle single / Preview multiple": "切换单窗口 / 预览多窗口",
    "Toggle single / Spread multiple": "切换单窗口 / 平铺多窗口",
    "Toggle windows": "切换窗口",
    "Top": "上",
    "Top and bottom margins": "上下边距",
    "Top and bottom padding": "上下内边距",
    "Touching the monitor's edge with the pointer reveals the panel": "指针触及显示器边缘时显示面板",
    "Travel": "位移",
    "Tray Font Size": "托盘字体大小",
    "Tray Item Padding": "托盘项内边距",
    "Ungroup applications": "取消分组应用",
    "Use a fixed width for the application titles": "为应用标题使用固定宽度",
    "Use custom opacity for the previews background": "为预览背景使用自定义不透明度",
    "Use different for unfocused": "未聚焦时使用不同样式",
    "Use hotkeys to activate apps": "使用快捷键激活应用",
    "Use the buttons below to create a settings file from your current preferences that can be imported on a different machine.": "使用下方按钮根据当前偏好生成设置文件，以便在其他设备上导入。",
    "Use the favorite icons as application launchers": "将收藏图标用作应用启动器",
    "Use this value to limit the number of captured mouse scroll events.": "用此值限制捕获的鼠标滚动事件数量。",
    "Version": "版本",
    "When hovering over a window preview for some time, the window gets distinguished.": "悬停窗口预览一段时间后，该窗口会高亮显示。",
    "When set to minimize, double clicking minimizes all the windows of the application.": "设为最小化时，双击将最小化该应用的所有窗口。",
    "Window peeking mode opacity": "窗口窥视模式不透明度",
    "Window previews aspect ratio X (width)": "窗口预览宽高比 X（宽）",
    "Window previews aspect ratio Y (height)": "窗口预览宽高比 Y（高）",
    "Window previews padding (px)": "窗口预览内边距（像素）",
    "Window previews preferred size (px)": "窗口预览首选大小（像素）",
    "Workspace Preview": "工作区预览",
    "Workspace spacing": "工作区间距",
    "Zoom": "缩放",
    "(default is 0)": "（默认为 0）",
    "(default is 4)": "（默认为 4）",
    "(default is 8)": "（默认为 8）",
    "(default is 48)": "（默认为 48）",
    "(default is 100)": "（默认为 100）",
    "(default is 160)": "（默认为 160）",
    "(right-click menu)": "（右键菜单）",
}

def extract_ui_strings():
    seen = set()
    for path in glob.glob("ui/*.ui"):
        with open(path, "r", encoding="utf-8") as f:
            text = f.read()
        for m in re.finditer(r'translatable="yes">([^<]*)<', text):
            s = m.group(1).strip()
            if s and s not in seen:
                seen.add(s)
                yield s

def main():
    # 1) Run rebuild_zh_CN.py to get base .po from .pot (JS strings)
    subprocess.run(["python3", "rebuild_zh_CN.py"], check=True)

    # 2) Read current .po and collect existing msgids
    with open("locale/zh_CN/LC_MESSAGES/dash-to-workspaces.po", "r", encoding="utf-8") as f:
        content = f.read()

    existing = set(re.findall(r'^msgid "(.+)"\s*$', content, re.MULTILINE))
    existing.discard("")  # header

    def esc(s):
        return s.replace("\\", "\\\\").replace('"', '\\"').replace("\n", "\\n")

    # 3) Append UI-only entries with Chinese where we have translation
    blocks = []
    for s in sorted(extract_ui_strings()):
        if s in existing:
            continue
        existing.add(s)
        trans = UI_TRANS.get(s, s)  # keep English if no translation
        trans_esc = esc(trans)
        id_esc = esc(s)
        blocks.append(f'#: (from .ui)\nmsgid "{id_esc}"\nmsgstr "{trans_esc}"\n')

    if not blocks:
        print("No new UI strings to add.")
    else:
        # Append before end of file (before last newline if any)
        content = content.rstrip()
        content += "\n\n" + "\n".join(blocks) + "\n"
        with open("locale/zh_CN/LC_MESSAGES/dash-to-workspaces.po", "w", encoding="utf-8") as f:
            f.write(content)
        print("Added", len(blocks), "UI translations to .po")

    # 4) Compile .mo
    r = subprocess.run(
        [
            "msgfmt",
            "-o",
            "locale/zh_CN/LC_MESSAGES/dash-to-workspaces.mo",
            "locale/zh_CN/LC_MESSAGES/dash-to-workspaces.po",
        ],
        capture_output=True,
        text=True,
    )
    if r.returncode != 0:
        print("msgfmt stderr:", r.stderr)
        raise SystemExit(1)
    print("Compiled dash-to-workspaces.mo")

if __name__ == "__main__":
    main()
